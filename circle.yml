machine:
  xcode:
    version: '8.3'
  environment:
    YARN_VERSION: 0.18.1
    # Needed for Android SDK installation bash script (see below)
    PATH: "${PATH}:${HOME}/.yarn/bin:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin"
    GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx2048m -XX:+HeapDumpOnOutOfMemoryError"'

dependencies:
  pre:
    # Install YARN
    - echo $KEYSTORE_BASE64 | base64 --decode | tee -a "android/$KEYSTORE"
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      fi

  override:
    # The Android Gradle build will need the Android signing keystore keys setup
    - echo y | android update sdk --no-ui --all --filter tools,platform-tools,build-tools-23.0.3,build-tools-25.0.2,build-tools-26.0.1,android-23,extra-google-m2repository,extra-google-google_play_services,extra-android-m2repository
    - echo y | $ANDROID_HOME/tools/bin/sdkmanager --update
    - echo y | $ANDROID_HOME/tools/bin/sdkmanager --licenses
    - mkdir -p ~/.gradle
    # Install node modules
    - yarn

  cache_directories:
    # Let's speed up the next build by cacheing installed dependencies
    - ~/.yarn
    - ~/.cache/yarn
    - vendor/bundle
    - node_modules
    - ~/Library/Caches/CocoaPods
    - /usr/local/android-sdk-linux/platforms/android-25
    - /usr/local/android-sdk-linux/build-tools/25.0.0
    - /usr/local/android-sdk-linux/extras/android/m2repository
test:
  override:
    - ./node_modules/.bin/react-native bundle --platform android --dev true --entry-file index.android.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res/
    - cd android && ./gradlew assembleRelease
    - mv ./android/app/build/outputs/ $CIRCLE_ARTIFACTS

deployment:
  production: # just a label; label names are completely up to you
    branch: master
    commands:
      - ./gradlew publishApkRelease
        -Dorg.gradle.project.track=production
  beta:
    branch: develop
    commands:
      - ./gradlew publishApkRelease
        -Dorg.gradle.project.track=beta
  alpha:
    branch: circle-ci
    commands:
      - ./gradlew publishApkRelease
        -Dorg.gradle.project.track=alpha
