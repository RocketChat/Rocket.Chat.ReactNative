appId: chat.rocket.reactnative
name: Discussion
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowComplete:
  - evalScript: ${output.utils.deleteCreatedUsers()}
tags:
  - test-10

---
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.room = output.utils.createRandomRoom(output.user.username, output.user.password)}
- evalScript: ${output.discussionFromNewMessage = output.random() + ' Discussion NewMessageView'}
- evalScript: ${output.discussionFromMessageComposer = output.random() + ' Discussion MessageComposer actions'}
- evalScript: ${output.selectUser = 'rocket.cat'}

- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}

# should create discussion from NewMessageView
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:
- assertVisible:
    id: 'rooms-list-view-create-channel'
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'new-message-view-create-discussion'
    timeout:
- tapOn:
    id: 'new-message-view-create-discussion'
- extendedWaitUntil:
    visible:
      id: 'select-users-view'
    timeout:
# Select users in SelectedUsersView
- extendedWaitUntil:
    visible:
      id: 'select-users-view-search'
    timeout:
- tapOn:
    id: 'select-users-view-search'
- inputText: ${output.selectUser}
- extendedWaitUntil:
    visible:
      id: 'select-users-view-item-${output.selectUser}'
    timeout:
- tapOn:
    id: 'select-users-view-item-${output.selectUser}'
- extendedWaitUntil:
    visible:
      id: 'selected-user-${output.selectUser}'
    timeout:
- tapOn:
    id: 'selected-users-view-submit'
- extendedWaitUntil:
    visible:
      id: 'create-discussion-view'
    timeout:
# Select channel and enter discussion name
- tapOn:
    id: 'create-discussion-select-channel'
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'multi-select-item-${output.room.name}'
    timeout:
- tapOn:
    id: 'multi-select-item-${output.room.name}'
- tapOn:
    id: 'multi-select-discussion-name'
- inputText: ${output.discussionFromNewMessage}
- tapOn:
    id: 'create-discussion-submit'
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.discussionFromNewMessage}'
    timeout:
- tapOn: 'Back'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-item-${output.discussionFromNewMessage}'
    timeout:

# should create discussion from MessageComposer Actions
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.room.name}
- extendedWaitUntil:
    visible:
      id: 'message-composer-actions'
    timeout:
- tapOn:
    id: message-composer-actions
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- assertVisible:
    text: Create discussion
- tapOn:
    text: Create discussion
- extendedWaitUntil:
    visible:
      id: 'create-discussion-view'
    timeout:
- extendedWaitUntil:
    visible:
      text: .*${output.room.name}.*
    timeout:
- tapOn:
    id: multi-select-discussion-name
- inputText: ${output.discussionFromMessageComposer}
- tapOn:
    id: create-discussion-submit
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.discussionFromMessageComposer}'
    timeout:

# Create Discussion from action sheet
- extendedWaitUntil:
    visible:
      id: 'message-composer'
    timeout:
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: 'message'
- extendedWaitUntil:
    visible:
      id: 'message-content-message'
    timeout:
- longPressOn:
    id: message-content-message
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- extendedWaitUntil:
    visible:
      text: 'Start a discussion'
    timeout:
- tapOn:
    text: Start a discussion
- extendedWaitUntil:
    visible:
      id: 'create-discussion-view'
    timeout:
- tapOn:
    id: create-discussion-submit
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'room-view-title-message'
    timeout:

# Check RoomActionsView render
- assertVisible:
    id: room-header
- tapOn:
    id: room-header
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      id: 'room-actions-view'
    timeout:

# should have room actions screen
- assertVisible:
    id: room-actions-view

# should have info
- assertVisible:
    id: room-actions-info

# should have members
- assertVisible:
    id: room-actions-members

# should have files
- assertVisible:
    id: room-actions-files

# should have mentions
- assertVisible:
    id: room-actions-mentioned

# should have starred
- assertVisible:
    id: room-actions-starred

# should have share
- assertVisible:
    id: room-actions-share

# should have pinned
- scrollUntilVisible:
    element:
      id: room-actions-pinned

# should not have notifications
- scrollUntilVisible:
    element:
      id: room-actions-notifications

# should not have leave channel
- scrollUntilVisible:
    element:
      id: room-actions-leave-channel

# should navigate to RoomActionView
- scrollUntilVisible:
    element:
      id: room-actions-info
    direction: UP
- tapOn:
    id: room-actions-info
- extendedWaitUntil:
    visible:
      id: 'room-info-view'
    timeout:

# should have edit button
- assertVisible:
    id: room-info-view-edit-button

# should go back to main room
- tapOn:
    id: custom-header-back
- extendedWaitUntil:
    visible:
      id: 'room-actions-view'
    timeout:
- tapOn:
    id: custom-header-back
- extendedWaitUntil:
    visible:
      id: 'room-view-messages'
    timeout:
- tapOn:
    id: header-back
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.room.name}

# should navigate to DiscussionsView
- extendedWaitUntil:
    visible:
      id: 'room-header'
    timeout:
- tapOn:
    id: 'room-header'
- extendedWaitUntil:
    visible:
      id: 'room-actions-discussions'
    timeout:
- tapOn:
    id: 'room-actions-discussions'
- extendedWaitUntil:
    visible:
      id: 'discussions-view'
    timeout:

# should navigate to discussion
- extendedWaitUntil:
    visible:
      id: 'discussions-view-${output.discussionFromNewMessage}'
    timeout:
- tapOn:
    id: 'discussions-view-${output.discussionFromNewMessage}'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.discussionFromNewMessage}'
    timeout:
