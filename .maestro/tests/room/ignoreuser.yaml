appId: chat.rocket.reactnative
name: Ignore User
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
tags:
  - test-11

---
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.otherUser = output.utils.createUser()}
- evalScript: ${output.room = output.utils.createRandomRoom(output.user.username, output.user.password)}

- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}

# should go to user info view
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.otherUser.username}
- runFlow:
    file: './utils/navigate-to-info-view.yaml'

# should block user
- extendedWaitUntil:
    visible:
      text: 'Block'
    timeout:
- tapOn: 'Block'
- extendedWaitUntil:
    visible:
      text: 'Unblock'
    timeout:
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'room-actions-view'
    timeout:
- runFlow: '../../helpers/go-back.yaml'
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.otherUser.username}
- extendedWaitUntil:
    visible:
      text: 'This room is blocked'
    timeout:

# should unblock user
- runFlow:
    file: './utils/navigate-to-info-view.yaml'
- extendedWaitUntil:
    visible:
      text: 'Unblock'
    timeout:
- tapOn: 'Unblock'
- extendedWaitUntil:
    visible:
      text: 'Block'
    timeout:
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'room-actions-view'
    timeout:
- runFlow: '../../helpers/go-back.yaml'
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.otherUser.username}
- extendedWaitUntil:
    visible:
      id: 'message-composer'
    timeout:
- runFlow: '../../helpers/go-back.yaml'

# should ignore user from message
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.room.name}
- evalScript: ${output.utils.sendMessage(output.otherUser.username, output.otherUser.password, output.room._id, 'message-01')}
- evalScript: ${output.utils.sendMessage(output.otherUser.username, output.otherUser.password, output.room._id, 'message-02')}
- extendedWaitUntil:
    visible:
      id: 'username-header-${output.otherUser.username}'
    timeout:
- tapOn:
    id: 'username-header-${output.otherUser.username}'
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      text: 'Ignore'
    timeout:
- tapOn: 'Ignore'
- extendedWaitUntil:
    visible:
      text: 'Unignore'
    timeout:
- runFlow: '../../helpers/go-back.yaml'

# should tap to display message
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.room.name}
- extendedWaitUntil:
    visible:
      text: .*Message ignored. Tap to display it.*
      index: 0
    timeout:
- tapOn:
    text: .*Message ignored. Tap to display it.*
    index: 0
- extendedWaitUntil:
    visible:
      id: 'username-header-${output.otherUser.username}'
    timeout:
- runFlow:
    when:
      platform: android
    commands:
      - extendedWaitUntil:
          visible:
            id: 'message-content-message-01'
          timeout:
- runFlow:
    when:
      platform: iOS
    commands:
      - extendedWaitUntil:
          visible:
            id: 'message-content-message-02'
          timeout:
- extendedWaitUntil:
    visible:
      id: 'username-header-${output.otherUser.username}'
    timeout:
- tapOn:
    id: 'username-header-${output.otherUser.username}'
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      text: 'Unignore'
    timeout:
- tapOn: 'Unignore'
- extendedWaitUntil:
    visible:
      text: 'Ignore'
    timeout:
- runFlow: '../../helpers/go-back.yaml'
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.room.name}
- extendedWaitUntil:
    visible:
      id: 'message-content-message-02'
      index: 0
    timeout:

# should go to user info view from a DM
- runFlow: '../../helpers/go-back.yaml'
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.otherUser.username}
- runFlow: './utils/navigate-to-info-view.yaml'

# should report a user from a DM
- extendedWaitUntil:
    visible:
      text: 'Report'
    timeout:
- tapOn: 'Report'
- extendedWaitUntil:
    visible:
      id: 'report-user-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'report-user-view-input'
    timeout:
- tapOn:
    id: 'report-user-view-input'
- inputText: 'e2e test'
- extendedWaitUntil:
    visible:
      id: 'report-user-view-submit'
    timeout:
- hideKeyboard
- tapOn:
    id: 'report-user-view-submit'
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.otherUser.username}'
    timeout:

# should go to user info view from a channel
- runFlow: '../../helpers/go-back.yaml'
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.room.name}
- extendedWaitUntil:
    visible:
      text: ${output.otherUser.username}
    timeout:
- tapOn: ${output.otherUser.username}
- extendedWaitUntil:
    visible:
      id: 'room-info-view'
    timeout:

# should report a user from a channel
- extendedWaitUntil:
    visible:
      text: 'Report'
- tapOn: 'Report'
- extendedWaitUntil:
    visible:
      id: 'report-user-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'report-user-view-input'
    timeout:
- tapOn:
    id: 'report-user-view-input'
- inputText: 'e2e test'
- hideKeyboard
- extendedWaitUntil:
    visible:
      id: 'report-user-view-submit'
    timeout:
- tapOn:
    id: 'report-user-view-submit'
    retryTapIfNoChange: true
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout:
