appId: chat.rocket.reactnative
name: Threads
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowComplete:
  - evalScript: ${output.utils.deleteCreatedUsers()}
tags:
  - test-12

---
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.otherUser = output.utils.createUser()}
- evalScript: ${output.room = output.utils.createRandomRoom(output.user.username, output.user.password)}

- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.room.name}

# should have room screen
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout:

# should have actions button
- extendedWaitUntil:
    visible:
      id: 'room-header'
    timeout:

# should have threads button
- extendedWaitUntil:
    visible:
      id: 'room-view-header-threads'
    timeout:

# should create thread
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: thread
- tapOn:
    id: 'room-view-messages'
- assertVisible:
    id: 'message-content-thread'
- longPressOn:
    id: 'message-content-thread'
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- extendedWaitUntil:
    visible:
      text: 'Reply in thread'
    timeout:
- tapOn:
    text: 'Reply in thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'message-composer-input-thread'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- inputText: replied
- tapOn:
    id: 'message-composer-send'
- extendedWaitUntil:
    visible:
      id: 'message-content-replied'
    timeout:
- tapOn:
    id: 'header-back'
# should navigate to thread from button
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'message-thread-button-thread'
    timeout:
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:

# should toggle follow thread
- extendedWaitUntil:
    visible:
      id: 'room-view-header-unfollow'
    timeout:
- tapOn:
    id: 'room-view-header-unfollow'
- extendedWaitUntil:
    visible:
      id: 'room-view-header-follow'
    timeout:
- tapOn:
    id: 'room-view-header-follow'
- extendedWaitUntil:
    visible:
      id: 'room-view-header-unfollow'
    timeout:

# should send message in thread only
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: threadonly
      isThread: 'true'
- tapOn:
    id: 'header-back'
- extendedWaitUntil:
    notVisible:
      id: 'room-view-title-thread'
    timeout: 5000
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout: 5000
- extendedWaitUntil:
    notVisible:
      id: 'message-content-threadonly'
    timeout: 5000

# should mark send to channel and show on main channel
- extendedWaitUntil:
    visible:
      id: 'message-thread-button-thread'
    timeout:
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- inputText: 'sendToChannel'
- tapOn:
    id: send-to-channel-unchecked
- tapOn:
    id: message-composer-send
- tapOn:
    id: header-back
- extendedWaitUntil:
    notVisible:
      id: 'room-view-title-thread'
    timeout: 5000
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout: 5000
- extendedWaitUntil:
    visible:
      text: '.*sendToChannel.*'
    timeout: 5000

# should navigate to thread from thread name
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: dummymessagebetweenthethread
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'message-composer-input-thread'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- inputText: 'navthreadname'
- tapOn:
    id: 'message-composer-send-to-channel'
- tapOn:
    id: 'message-composer-send'
- tapOn:
    id: 'header-back'
- extendedWaitUntil:
    notVisible:
      id: 'room-view-title-thread'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'message-thread-replied-on-thread'
    timeout:
- tapOn:
    id: 'message-thread-replied-on-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- tapOn:
    id: 'header-back'

# should navigate to thread from threads view
- extendedWaitUntil:
    visible:
      id: 'room-view-header-threads'
    timeout:
- tapOn:
    id: 'room-view-header-threads'
- extendedWaitUntil:
    visible:
      id: 'thread-messages-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'thread-messages-view-thread'
    timeout:
- tapOn:
    id: 'thread-messages-view-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- tapOn:
    id: 'header-back'
- extendedWaitUntil:
    visible:
      id: 'room-view-messages'
    timeout:

# should draft thread message
- extendedWaitUntil:
    visible:
      id: 'message-thread-button-thread'
    timeout:
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- inputText: 'draftthread'
- tapOn:
    id: 'header-back'

- extendedWaitUntil:
    visible:
      id: 'message-thread-button-thread'
    timeout:
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- extendedWaitUntil:
    visible:
      text: '.*draftthread.*'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- eraseText
- tapOn:
    id: 'header-back'

- extendedWaitUntil:
    visible:
      id: 'message-thread-button-thread'
    timeout:
- tapOn:
    id: 'message-thread-button-thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread'
    timeout:
- extendedWaitUntil:
    notVisible:
      text: '.*draftthread.*'
    timeout:
- extendedWaitUntil:
    visible:
      text: '.*Add thread reply.*'
    timeout:
- tapOn:
    id: 'header-back'

# should create thread delete the message and the thread show the correct number of messages
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: 'thread-message-count'
- extendedWaitUntil:
    visible:
      id: 'message-content-thread-message-count'
    timeout:
- longPressOn:
    id: 'message-content-thread-message-count'
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- extendedWaitUntil:
    visible:
      text: 'Reply in thread'
    timeout:
- tapOn:
    text: 'Reply in thread'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-thread-message-count'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'message-composer-input-thread'
    timeout:
- tapOn:
    id: 'message-composer-input-thread'
- inputText: 'replied'
- tapOn:
    id: 'message-composer-send'
- extendedWaitUntil:
    visible:
      id: 'message-content-replied'
    timeout:
- longPressOn:
    id: 'message-content-replied'
- extendedWaitUntil:
    visible:
      id: 'action-sheet'
    timeout:
- swipe:
    from:
      id: 'action-sheet-handle'
    direction: UP
- scrollUntilVisible:
    element:
      text: 'Delete'
    timeout:
- tapOn:
    text: 'Delete'
- extendedWaitUntil:
    visible:
      text: '.*You will not be able to recover this message.*'
    timeout:
- tapOn: 'DELETE'
- tapOn:
    id: 'header-back'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room.name}'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'thread-count-0'
    timeout:
