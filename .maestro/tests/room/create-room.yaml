appId: chat.rocket.reactnative
name: Create Room
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowComplete:
  - evalScript: ${output.utils.deleteCreatedUsers()}
tags:
  - test-10

---
- evalScript: ${output.user = output.utils.createUser()}
- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}

- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-create-channel'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'

# should have new message screen
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 

# should have search input
- extendedWaitUntil:
    visible:
      id: 'new-message-view-search'
    timeout: 

# should back to rooms list
- extendedWaitUntil:
    visible:
      id: 'new-message-view-close'
    timeout: 
- tapOn:
    id: 'new-message-view-close'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 

# should search user and navigate
- extendedWaitUntil:
    visible:
      id: 'new-message-view-search'
    timeout: 
- tapOn:
    id: 'new-message-view-search'
- inputText: 'rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'new-message-view-item-rocket.cat'
    timeout: 
- tapOn:
    id: 'new-message-view-item-rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'room-view-title-rocket.cat'
    timeout: 
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 

# should navigate to select users
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-create-channel'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'new-message-view-create-channel'
    timeout: 
- tapOn:
    id: 'new-message-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'select-users-view'
    timeout: 

# should search users
- extendedWaitUntil:
    visible:
      id: 'select-users-view-search'
    timeout: 
- tapOn:
    id: 'select-users-view-search'
- inputText: 'rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'select-users-view-item-rocket.cat'
    timeout: 

# should select/unselect user
- tapOn:
    id: 'select-users-view-item-rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'selected-user-rocket.cat'
    timeout: 
- tapOn:
    id: 'selected-user-rocket.cat'
- extendedWaitUntil:
    notVisible:
      id: 'selected-user-rocket.cat'
    timeout: 
- assertVisible:
    id: 'select-users-view-item-rocket.cat'
- tapOn:
    id: 'select-users-view-item-rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'selected-user-rocket.cat'
    timeout: 

# should navigate to create channel view
- extendedWaitUntil:
    visible:
      id: 'selected-users-view-submit'
    timeout: 
- tapOn:
    id: 'selected-users-view-submit'
- extendedWaitUntil:
    visible:
      id: 'create-channel-view'
    timeout: 

# should render all fields
- extendedWaitUntil:
    visible:
      id: 'create-channel-name'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'create-channel-type'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'create-channel-readonly'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'create-channel-broadcast'
    timeout: 

# should get invalid room
- tapOn:
    id: 'create-channel-name'
- inputText: 'general'
- hideKeyboard
- extendedWaitUntil:
    visible:
      id: 'create-channel-submit'
    timeout: 
- tapOn:
    id: 'create-channel-submit'
- extendedWaitUntil:
    visible:
      text: '.*A channel with name general exists.*'
    timeout: 
- tapOn: 'OK'

# should create public room
- evalScript: ${output.publicRoomName = 'public' + output.random()}
- tapOn:
    id: 'create-channel-name'
- eraseText: 100
- inputText: ${output.publicRoomName}
- hideKeyboard
- tapOn:
    id: 'create-channel-type'
- extendedWaitUntil:
    visible:
      id: 'create-channel-submit'
    timeout: 
- tapOn:
    id: 'create-channel-submit'
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'room-view-title-' + output.publicRoomName}
    timeout: 
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'rooms-list-view-item-' + output.publicRoomName}
    timeout: 

# should create private room
- evalScript: ${output.privateRoomName = 'private' + output.random()}
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-create-channel'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'new-message-view-create-channel'
    timeout: 
- tapOn:
    id: 'new-message-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'select-users-view'
    timeout: 
- tapOn:
    id: 'select-users-view-item-rocket.cat'
- extendedWaitUntil:
    visible:
      id: 'selected-user-rocket.cat'
    timeout: 
- tapOn:
    id: 'selected-users-view-submit'
- extendedWaitUntil:
    visible:
      id: 'create-channel-view'
    timeout: 
- tapOn:
    id: 'create-channel-name'
- inputText: ${output.privateRoomName}
- hideKeyboard
- extendedWaitUntil:
    visible:
      id: 'create-channel-submit'
    timeout: 
- tapOn:
    id: 'create-channel-submit'
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'room-view-title-' + output.privateRoomName}
    timeout: 
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'rooms-list-view-item-' + output.privateRoomName}
    timeout: 

# should create empty room
- evalScript: ${output.emptyRoomName = 'empty' + output.random()}
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-create-channel'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'new-message-view-create-channel'
    timeout: 
- tapOn:
    id: 'new-message-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'select-users-view'
    timeout: 
- tapOn:
    id: 'selected-users-view-submit'
- extendedWaitUntil:
    visible:
      id: 'create-channel-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'create-channel-name'
    timeout: 
- tapOn:
    id: 'create-channel-name'
- inputText: ${output.emptyRoomName}
- hideKeyboard
- extendedWaitUntil:
    visible:
      id: 'create-channel-submit'
    timeout: 
- tapOn:
    id: 'create-channel-submit'
- extendedWaitUntil:
    visible:
      id: 'room-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'room-view-title-' + output.emptyRoomName}
    timeout: 
- runFlow: '../../helpers/go-back.yaml'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: ${'rooms-list-view-item-' + output.emptyRoomName}
    timeout: 

# should create a room with non-latin alphabet and do a case insensitive search for it
- runFlow:
    when:
      platform: iOS
    commands:
      - evalScript: ${output.nonLatinRoomName = 'ПРОВЕРКА' + output.random()}
      - evalScript: ${output.nonLatinRoomNameLower = output.nonLatinRoomName.toLowerCase()}

      - extendedWaitUntil:
          visible:
            id: 'rooms-list-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: 'rooms-list-view-create-channel'
          timeout: 
      - tapOn:
          id: 'rooms-list-view-create-channel'
      - extendedWaitUntil:
          visible:
            id: 'new-message-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: 'new-message-view-create-channel'
          timeout: 
      - tapOn:
          id: 'new-message-view-create-channel'
      - extendedWaitUntil:
          visible:
            id: 'select-users-view'
          timeout: 
      - tapOn:
          id: 'selected-users-view-submit'
      - extendedWaitUntil:
          visible:
            id: 'create-channel-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: 'create-channel-name'
          timeout: 
      - tapOn:
          id: 'create-channel-name'
      - inputText: ${output.nonLatinRoomName}
      - hideKeyboard
      - extendedWaitUntil:
          visible:
            id: 'create-channel-submit'
          timeout: 
      - tapOn:
          id: 'create-channel-submit'
      - extendedWaitUntil:
          visible:
            id: 'room-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: ${'room-view-title-' + output.nonLatinRoomName}
          timeout: 
      - runFlow: '../../helpers/go-back.yaml'
      - extendedWaitUntil:
          visible:
            id: 'rooms-list-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: ${'rooms-list-view-item-' + output.nonLatinRoomName}
          timeout: 
      - extendedWaitUntil:
          visible:
            id: 'rooms-list-view-search'
          timeout: 
      - tapOn:
          id: 'rooms-list-view-search'
      - extendedWaitUntil:
          visible:
            id: 'rooms-list-view-search-input'
          timeout: 
      - tapOn:
          id: 'rooms-list-view-search-input'
      - inputText: ${output.nonLatinRoomNameLower}
      - hideKeyboard
      - extendedWaitUntil:
          visible:
            id: ${'rooms-list-view-item-' + output.nonLatinRoomName}
          timeout: 
      - tapOn:
          id: ${'rooms-list-view-item-' + output.nonLatinRoomName}
      - extendedWaitUntil:
          visible:
            id: 'room-view'
          timeout: 
      - extendedWaitUntil:
          visible:
            id: ${'room-view-title-' + output.nonLatinRoomName}
          timeout: 
