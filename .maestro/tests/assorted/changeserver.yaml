appId: chat.rocket.reactnative
name: Change Server
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowComplete:
  - evalScript: ${output.utils.deleteCreatedUsers()}
tags:
  - test-5

---
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.room = output.utils.createRandomRoom(output.user.username, output.user.password)}

- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}

# should open the servers list, have the server add button and create workspace button
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list-button'
    timeout:
- tapOn:
    id: 'rooms-list-header-servers-list-button'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-server-add'
    timeout:

# should login to server, add new server, close the app, open the app and show previous logged server
- tapOn:
    id: 'rooms-list-header-server-add'
- extendedWaitUntil:
    visible:
      id: 'new-server-view'
    timeout:
- tapOn:
    id: 'new-server-view-input'
- inputText: ${output.data.alternateServer}
- pressKey: 'enter'
- extendedWaitUntil:
    visible:
      id: 'workspace-view'
    timeout:
- launchApp
- waitForAnimationToEnd:
    timeout: 500
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:

# should add server and create new user
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list-button'
    timeout:
- tapOn:
    id: 'rooms-list-header-servers-list-button'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'server-item-${output.data.alternateServer}'
    timeout:
- waitForAnimationToEnd:
    timeout: 5000
- tapOn:
    id: 'server-item-${output.data.alternateServer}'
- extendedWaitUntil:
    visible:
      id: 'workspace-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'workspace-view-register'
    timeout:
- tapOn:
    id: 'workspace-view-register'
- extendedWaitUntil:
    visible:
      id: 'register-view-name'
    timeout:
- runFlow: '../../helpers/create-account.yaml'
- extendedWaitUntil:
    notVisible:
      id: 'rooms-list-view-item-${output.room.name}'
    timeout:

# should reopen the app and show alternate server
- launchApp
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:
- runFlow:
    file: './utils/check-server.yaml'
    env:
      server: ${output.data.alternateServer}

# should change back to main server
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list-button'
    timeout:
- waitForAnimationToEnd:
    timeout: 5000
- tapOn:
    id: 'rooms-list-header-servers-list-button'
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'server-item-${output.data.server}'
    timeout:
- tapOn:
    id: 'server-item-${output.data.server}'
- waitForAnimationToEnd:
    timeout: 500
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-item-${output.room.name}'
    timeout:
- runFlow:
    file: './utils/check-server.yaml'
    env:
      server: ${output.data.server}

# should reopen the app and show main server
- launchApp
- waitForAnimationToEnd:
    timeout: 500
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view'
    timeout:
- runFlow:
    file: './utils/check-server.yaml'
    env:
      server: ${output.data.server}

# should test swipe to delete on alternate server
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list-button'
    timeout:
- tapOn:
    id: 'rooms-list-header-servers-list-button'
- extendedWaitUntil:
    visible:
      id: 'server-item-${output.data.alternateServer}'
    timeout:

# swipe left to reveal delete button
- swipe:
    direction: LEFT
    from:
      id: 'server-item-${output.data.alternateServer}'

# tap delete button
- tapOn:
    id: 'server-item-${output.data.alternateServer}-delete'

# confirm deletion
- extendedWaitUntil:
    visible:
      text: '.*Delete.*'
    timeout:
- runFlow:
    when:
      platform: iOS
    commands:
      - tapOn:
          point: 65%,55%
          retryTapIfNoChange: true
- runFlow:
    when:
      platform: Android
    commands:
      - tapOn:
          text: 'Delete'
          retryTapIfNoChange: true

# verify alternate server is deleted
- waitForAnimationToEnd:
    timeout: 500
- extendedWaitUntil:
    visible:
      id: 'rooms-list-header-servers-list-button'
    timeout:
- tapOn:
    id: 'rooms-list-header-servers-list-button'
- extendedWaitUntil:
    notVisible:
      id: 'server-item-${output.data.alternateServer}'
    timeout:

# verify main server still exists
- assertVisible:
    id: 'server-item-${output.data.server}'
