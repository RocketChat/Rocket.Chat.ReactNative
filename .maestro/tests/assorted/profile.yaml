appId: chat.rocket.reactnative
name: Profile
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowEnd:
  - evalScript: ${output.utils.deleteCreatedUsers()}

---
- evalScript: ${output.room = 'broadcast' + output.random()}
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.otherUser = output.utils.createUser()}

- runFlow: ../../helpers/launch-app.yaml
- runFlow:
    file: '../../helpers/login.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-sidebar'
    timeout: 60000
- tapOn:
    id: 'rooms-list-view-sidebar'
- extendedWaitUntil:
    visible:
      id: 'sidebar-view'
    timeout: 60000
- extendedWaitUntil:
    visible:
      id: 'sidebar-profile'
    timeout: 60000
- tapOn:
    id: 'sidebar-profile'
- extendedWaitUntil:
    visible:
      id: 'profile-view'
    timeout: 60000

# should have profile view
- assertVisible:
    id: 'profile-view'

# should have avatar
- assertVisible:
    id: 'profile-view-avatar'

# should have avatar edit button
- assertVisible:
    id: 'avatar-edit-button'

# should have name
- assertVisible:
    id: 'profile-view-name'

# should have username
- assertVisible:
    id: 'profile-view-username'

# should have email
- assertVisible:
    id: 'profile-view-email'

# should have new password
- assertVisible:
    id: 'profile-view-change-my-password-button'

# should have submit button
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000

# should change name and username
- assertVisible:
    id: 'profile-view-name'
- tapOn:
    id: 'profile-view-name'
- eraseText
- inputText: ${output.user.name + 'new'}
- pressKey: enter
- assertVisible:
    id: 'profile-view-username'
- tapOn:
    id: 'profile-view-username'
- eraseText
- inputText: ${output.user.username + 'new'}
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'

# should change nickname and bio
- assertVisible:
    id: 'profile-view-nickname'
- tapOn:
    id: 'profile-view-nickname'
- eraseText
- inputText: ${output.user.nickname + 'new'}
- pressKey: enter
- assertVisible:
    id: 'profile-view-bio'
- tapOn:
    id: 'profile-view-bio'
- eraseText
- inputText: ${output.user.bio + 'new'}
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'

# should change email
- scrollUntilVisible:
    element:
      id: 'profile-view-email'
    timeout: 60000
- tapOn:
    id: 'profile-view-email'
- eraseText
- inputText: mobile+profileChangesNew${output.random()}@rocket.chat
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'
- extendedWaitUntil:
    visible:
      id: 'profile-view-enter-password-sheet-input'
    timeout: 60000
- tapOn:
    id: 'profile-view-enter-password-sheet-input'
- inputText: ${output.user.password}
- pressKey: enter
- extendedWaitUntil:
    visible:
      id: 'profile-view-enter-password-sheet-confirm'
    timeout: 60000
- tapOn:
    id: 'profile-view-enter-password-sheet-confirm'

# should change password
- scrollUntilVisible:
    element:
      id: 'profile-view-change-my-password-button'
    timeout: 60000
- assertVisible:
    id: 'change-password-view-current-password'
- tapOn:
    id: 'change-password-view-current-password'
- inputText: ${output.user.password}
- pressKey: enter
- assertVisible:
    id: 'change-password-view-new-password'
- tapOn:
    id: 'change-password-view-new-password'
- inputText: ${output.user.password + 'new'}
- pressKey: enter
- assertVisible:
    id: 'change-password-view-confirm-new-password'
- tapOn:
    id: 'change-password-view-confirm-new-password'
- inputText: ${output.user.password + 'new'}
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'change-password-view-set-new-password-button'
    timeout: 60000
- tapOn:
    id: 'change-password-view-set-new-password-button'
- extendedWaitUntil:
    visible:
      id: 'profile-view'
    timeout: 60000
