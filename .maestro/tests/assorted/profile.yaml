appId: chat.rocket.reactnative
name: Profile
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowEnd:
  - evalScript: ${output.utils.deleteCreatedUsers()}

---
- evalScript: ${output.user = output.utils.createUser()}

- runFlow: ../../helpers/launch-app.yaml
- runFlow:
    file: '../../helpers/login.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-sidebar'
    timeout: 60000
- tapOn:
    id: 'rooms-list-view-sidebar'
- extendedWaitUntil:
    visible:
      id: 'sidebar-view'
    timeout: 60000
- extendedWaitUntil:
    visible:
      id: 'sidebar-profile'
    timeout: 60000
- tapOn:
    id: 'sidebar-profile'
- extendedWaitUntil:
    visible:
      id: 'profile-view'
    timeout: 60000

# should have profile view
- assertVisible:
    id: 'profile-view'

# should have avatar
- assertVisible:
    id: 'profile-view-avatar'

# should have avatar edit button
- assertVisible:
    id: 'avatar-edit-button'

# should have name
- assertVisible:
    id: 'profile-view-name'

# should have username
- assertVisible:
    id: 'profile-view-username'

# should have email
- assertVisible:
    id: 'profile-view-email'

# should have new password
- assertVisible:
    id: 'profile-view-change-my-password-button'

# should have submit button
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000

# submit button should be disabled because of no changes
- assertVisible:
    id: 'profile-view-submit'
    enabled: false

# swipe back to top
- swipe:
    from:
      id: 'profile-view-submit'
    direction: up

# should change name and username
- assertVisible:
    id: 'profile-view-name'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-name'
- inputText: ${output.user.name + 'newname'}
- pressKey: enter
- assertVisible:
    id: 'profile-view-username'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-username'
- inputText: ${output.user.username + 'username'}
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'

# should change nickname and bio
- assertVisible:
    id: 'profile-view-nickname'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-nickname'
- inputText: ${output.user.username + 'newnickname'}
- pressKey: enter
- assertVisible:
    id: 'profile-view-bio'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-bio'
- inputText: ${output.user.username + 'newbio'}
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'

# should change email
- scrollUntilVisible:
    element:
      id: 'profile-view-email'
    timeout: 60000
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-email'
- inputText: mobile+profileChangesNew${output.random()}@rocket.chat
- pressKey: enter
- scrollUntilVisible:
    element:
      id: 'profile-view-submit'
    timeout: 60000
- tapOn:
    id: 'profile-view-submit'
- extendedWaitUntil:
    visible:
      id: 'profile-view-enter-password-sheet-input'
    timeout: 60000
- tapOn:
    id: 'profile-view-enter-password-sheet-input'
- inputText: ${output.user.password}
- pressKey: enter
- extendedWaitUntil:
    notVisible:
      id: 'profile-view-enter-password-sheet-input'
    timeout: 60000

# should change password
- scrollUntilVisible:
    element:
      id: 'profile-view-change-my-password-button'
    timeout: 60000
- tapOn:
    id: 'profile-view-change-my-password-button'
- extendedWaitUntil:
    visible:
      id: 'change-password-view-current-password'
    timeout: 60000
- tapOn:
    id: 'change-password-view-current-password'
- inputText: ${output.user.password}
- pressKey: enter
- assertVisible:
    id: 'change-password-view-new-password'
- tapOn:
    id: 'change-password-view-new-password'
- inputText: ${output.user.password + 'new'}
- hideKeyboard
- assertVisible:
    id: 'change-password-view-confirm-new-password'
- tapOn:
    id: 'change-password-view-confirm-new-password'
- inputText: ${output.user.password + 'new'}
- hideKeyboard
- scrollUntilVisible:
    element:
      id: 'change-password-view-set-new-password-button'
    timeout: 60000
- tapOn:
    id: 'change-password-view-set-new-password-button'
- extendedWaitUntil:
    visible:
      id: 'profile-view'
    timeout: 60000

# should show validation error when name is empty
- assertVisible:
    id: 'profile-view-name'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-name'
- pressKey: enter
- extendedWaitUntil:
    visible:
      text: '.*Name required.*'
    timeout: 60000

# should show validation error when username is empty
- assertVisible:
    id: 'profile-view-username'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-username'
- pressKey: enter
- extendedWaitUntil:
    visible:
      text: '.*Username required.*'
    timeout: 60000

# should show validation error when email is wrong
- assertVisible:
    id: 'profile-view-email'
- runFlow:
    file: '../../helpers/erase-text.yaml'
    env:
      id: 'profile-view-email'
- inputText: wrongemail
- extendedWaitUntil:
    visible:
      text: '.*Email must be a valid email.*'
    timeout: 60000
