appId: chat.rocket.reactnative
name: Broadcast
onFlowStart:
  - runFlow: '../../helpers/setup.yaml'
onFlowComplete:
  - evalScript: ${output.utils.deleteCreatedUsers()}
tags:
  - test-5

---
- evalScript: ${output.room = 'broadcast' + output.random()}
- evalScript: ${output.user = output.utils.createUser()}
- evalScript: ${output.otherUser = output.utils.createUser()}

- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.user.username}
      PASSWORD: ${output.user.password}

# should create broadcast room
- extendedWaitUntil:
    visible:
      id: 'rooms-list-view-create-channel'
    timeout: 
- tapOn:
    id: 'rooms-list-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'new-message-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'new-message-view-create-channel'
    timeout: 
- tapOn:
    id: 'new-message-view-create-channel'
- extendedWaitUntil:
    visible:
      id: 'select-users-view'
    timeout: 
- tapOn:
    id: 'select-users-view-search'
- inputText: ${output.otherUser.username}
- extendedWaitUntil:
    visible:
      id: 'select-users-view-item-${output.otherUser.username}'
    timeout: 
- tapOn:
    id: 'select-users-view-item-${output.otherUser.username}'
- extendedWaitUntil:
    visible:
      id: 'selected-user-${output.otherUser.username}'
    timeout: 
- assertVisible:
    id: 'selected-users-view-submit'
- tapOn:
    id: 'selected-users-view-submit'
- extendedWaitUntil:
    visible:
      id: 'create-channel-view'
    timeout: 
- assertVisible:
    id: 'create-channel-name'
- tapOn:
    id: 'create-channel-name'
- inputText: ${output.room}
- hideKeyboard
- assertVisible:
    id: 'create-channel-broadcast'
- tapOn:
    id: 'create-channel-broadcast'
- extendedWaitUntil:
    visible:
      id: 'create-channel-submit'
    timeout: 
- tapOn:
    id: 'create-channel-submit'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room}'
- tapOn:
    id: 'room-header'
- extendedWaitUntil:
    visible:
      id: 'room-actions-view'
    timeout: 
- tapOn:
    id: 'room-actions-info'
- extendedWaitUntil:
    visible:
      id: 'room-info-view'
    timeout: 
- extendedWaitUntil:
    visible:
      id: 'room-info-view-broadcast'
    timeout: 
- runFlow: ../../helpers/go-back.yaml
- runFlow: ../../helpers/go-back.yaml
- runFlow:
    file: '../../helpers/navigate-to-room.yaml'
    env:
      ROOM: ${output.room}
- runFlow:
    file: '../../helpers/send-message.yaml'
    env:
      message: 'message'

# should login as user without write message authorization and enter room
- runFlow:
    file: '../../helpers/login-with-deeplink.yaml'
    env:
      USERNAME: ${output.otherUser.username}
      PASSWORD: ${output.otherUser.password}
      CLEAR_STATE: true
- runFlow:
    file: '../../helpers/search-and-navigate-room.yaml'
    env:
      ROOM: ${output.room}
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room}'
    timeout: 

# should not have message composer
- assertNotVisible:
    id: 'message-composer'

# should be read only
- assertVisible:
    label: 'This room is read only'

# should have the message created earlier
- assertVisible:
    id: 'message-content-message'

# should tap on reply button and navigate to direct room
- assertVisible:
    id: 'message-broadcast-reply'
- tapOn:
    id: 'message-broadcast-reply'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.user.username}'
    timeout: 

# should reply broadcasted message
- assertVisible:
    id: 'message-composer-input'
- tapOn:
    id: 'message-composer-input'
- inputText: 'broadcastreply'
- tapOn:
    id: 'message-composer-send'
- extendedWaitUntil:
    visible:
      text: '.*broadcastreply.*'
    timeout: 
- longPressOn:
    text: '.*broadcastreply.*'
    index: 0
- extendedWaitUntil:
    visible:
      text: 'Jump to message'
    timeout: 
- tapOn:
    text: 'Jump to message'
- extendedWaitUntil:
    visible:
      id: 'room-view-title-${output.room}'
